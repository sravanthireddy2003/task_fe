import{b as ee,s as se,r as d,j as e,G as te,a4 as b,e as f}from"./index-CV0oviIo.js";import{V as ae}from"./ViewToggle-CoYvpou8.js";const{Eye:W,Check:O,X:M,RefreshCw:y,AlertCircle:E,User:z,Clock:ne}=te,re=()=>{ee(se);const[I,X]=d.useState("list"),[_,L]=d.useState(!0),[k,H]=d.useState([]),[r,R]=d.useState(null),[K,A]=d.useState(!1),[o,S]=d.useState(""),[T,N]=d.useState([]),[$,C]=d.useState(!1),[P,V]=d.useState(null),[v,J]=d.useState(null),[U,D]=d.useState(null),w=async()=>{try{L(!0);const s=await b("/api/tasks/reassign-requests");if(s&&s.success&&Array.isArray(s.requests)){const t=s.requests.reduce((a,n)=>{const c=n.id;return a[c]||(a[c]={...n,assignees:[]}),n.current_assignee_name?(a[c].assignees.push({id:n.current_assignee_id||null,name:n.current_assignee_name,department:n.current_assignee_department_name||null}),a):n.assigned_to?(typeof n.assigned_to=="string"||typeof n.assigned_to=="number"?a[c].assignees.push({id:n.assigned_to,name:null}):typeof n.assigned_to=="object"&&n.assigned_to!==null&&a[c].assignees.push({id:n.assigned_to.id||null,name:n.assigned_to.name||null}),a):(Array.isArray(n.assignees)&&n.assignees.length&&n.assignees.forEach(m=>a[c].assignees.push({id:m.id||null,name:m.name||null,department:m.department})),a)},{});N(Object.values(t))}else N([])}catch{f.error("Failed to load reassignment requests"),N([])}finally{L(!1)}},Q=async()=>{try{const s=await b("/api/manager/employees/all");s&&s.success&&Array.isArray(s.data)&&H(s.data)}catch{}},Y=(s,t)=>{s&&(R({...t,id:s}),D(s),A(!0))},Z=async(s,t)=>{if(!(!s||v)){J(s);try{const a=t.task_id||t.task_public_id,n=await b(`/api/tasks/${a}/reassign-requests/${s}/reject`,{method:"POST"});if(n&&n.error)throw new Error(n.error);f.success((n==null?void 0:n.message)||"Request rejected. Task unlocked."),N(c=>c.map(m=>m.id===s?{...m,status:"REJECTED"}:m)),w()}catch(a){f.error((a==null?void 0:a.message)||"Failed to reject request")}finally{J(null)}}},q=async()=>{var s,t,a,n,c,m;if(!r||!o){f.error("Select an employee to reassign the task to");return}if(U){C(!0),V(U);try{const i=r.task_id||r.task_public_id,l=await b(`/api/tasks/${encodeURIComponent(i)}/reassign-requests/${U}/approve`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({new_assignee_id:o,assigned_to:[o],status:"In Progress",task_status:{current_status:"In Progress"}})});if(l&&l.error)throw new Error(l.error||"Approve + reassign failed");try{const x=l&&l.assigned_to&&(l.assigned_to.name||l.assigned_to.full_name)||(k.find(p=>String(p.id)===String(o))||{}).name||String(o);N(p=>p.map(u=>u.id===U?{...u,status:"Approved",assignees:[{id:o,name:x}],responded_at:l.responded_at||u.responded_at,responded_by:l.responded_by||u.responded_by,responder_name:l.responder_name||u.responder_name}:u))}catch(x){console.warn("Failed to update local requests after approve",x)}f.success((l==null?void 0:l.message)||"Reassignment approved and applied"),A(!1),S(""),R(null),D(null),w()}catch(i){const l=((t=(s=i==null?void 0:i.response)==null?void 0:s.data)==null?void 0:t.message)||(i==null?void 0:i.message)||((a=i==null?void 0:i.data)==null?void 0:a.message)||"Failed to approve and reassign";f.error(l)}finally{C(!1),V(null)}return}C(!0);try{const i=r.task_id||r.task_public_id,l=r.project_public_id;let x=null;try{const h=await b(`/api/tasks/${encodeURIComponent(i)}`),j=(h==null?void 0:h.data)||h||{};Array.isArray(j.assignedUsers)&&j.assignedUsers.length?x=j.assignedUsers[0].id||j.assignedUsers[0].internalId||j.assignedUsers[0].public_id||null:Array.isArray(j.assigned_to)&&j.assigned_to.length?x=j.assigned_to[0]:r&&Array.isArray(r.assignees)&&r.assignees.length&&(x=r.assignees[0].id||null)}catch(h){console.warn("Could not fetch task details for assignee resolution",h)}const p=[];x&&p.push({id:x,readOnly:!0}),o&&p.push({id:o,readOnly:!1});const u={assignedUsers:p,assigned_to:p.map(h=>h.id).filter(Boolean),projectId:l,project_id:l,status:"In Progress",stage:"In Progress",handleResignationRequestId:r.id,task_status:{current_status:"In Progress"}},F=await b(`/api/projects/tasks/${encodeURIComponent(i)}`,{method:"PUT",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify(u)});if(F&&F.error)throw new Error(F.error||"Reassignment failed");f.success("Task reassigned successfully!"),A(!1),S(""),R(null),w()}catch(i){const l=((c=(n=i==null?void 0:i.response)==null?void 0:n.data)==null?void 0:c.message)||(i==null?void 0:i.message)||((m=i==null?void 0:i.data)==null?void 0:m.message)||"Reassignment failed";f.error(l)}finally{C(!1)}},g=d.useMemo(()=>{const s=t=>{if(!t)return null;if(t.name)return t.department?`${t.name} (${t.department})`:t.name;if(t.id){const a=k.find(n=>String(n.id||n._id)===String(t.id));return a?a.name||a.full_name||a.first_name+" "+a.last_name:String(t.id)}return null};return T.map(t=>({id:t.id,type:"task_reassignment",department:t.project_department_names||`Project ${t.project_id||"Unknown"}`,project:t.project_name||`Project ${t.project_id||"Unknown"}`,title:`Task Reassignment: ${t.task_title||"Unknown Task"}`,requester:t.requester_name||"Unknown",assignedTo:(()=>{if(t.assignees&&t.assignees.length>0){const a=t.assignees.map(n=>s(n)).filter(Boolean);return a.length?a.join(", "):"Unassigned"}return"Unassigned"})(),date:t.requested_at?new Date(t.requested_at).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"}):"N/A",time:t.requested_at?new Date(t.requested_at).toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"}):"",status:t.status==="PENDING"?"Pending":t.status==="APPROVE"?"Approved":t.status==="REJECT"?"Rejected":t.status,requestData:t,reason:t.reason,task:{id:t.task_id,public_id:t.task_public_id,title:t.task_title,status:t.task_status,taskDate:t.taskDate,priority:t.priority,project_id:t.project_id}}))},[T,k]),B=s=>{const t=T.find(a=>a.id===s);t&&Y(s,t)},G=s=>{const t=T.find(a=>a.id===s);t&&Z(s,t)};return d.useEffect(()=>{w(),Q()},[]),e.jsxs("div",{className:"p-4 md:p-6 bg-gray-50 min-h-screen",children:[e.jsxs("div",{className:"flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4",children:[e.jsxs("div",{className:"w-full",children:[e.jsx("h2",{className:"text-2xl md:text-3xl font-bold text-gray-800 mb-2",children:"Approval Workflows"}),e.jsx("p",{className:"text-gray-600 text-sm md:text-base",children:"Manage task reassignment requests and other approvals"})]}),e.jsxs("div",{className:"flex gap-2 w-full md:w-auto",children:[e.jsxs("button",{onClick:w,disabled:_,className:"flex-1 md:flex-none p-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 disabled:opacity-50 flex items-center justify-center gap-2 transition-colors",title:"Refresh",children:[e.jsx(y,{className:_?"tm-icon animate-spin":"tm-icon"}),e.jsx("span",{className:"hidden sm:inline",children:"Refresh"})]}),e.jsx(ae,{mode:I==="list"?"list":"grid",onChange:s=>X(s==="list"?"list":"card")})]})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6",children:[e.jsx("div",{className:"bg-white rounded-xl p-4 shadow-sm border",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500",children:"Total Requests"}),e.jsx("p",{className:"text-2xl font-bold text-gray-800",children:g.length})]}),e.jsx("div",{className:"p-2 bg-blue-100 rounded-lg flex items-center justify-center",children:e.jsx(E,{className:"tm-icon text-blue-600"})})]})}),e.jsx("div",{className:"bg-white rounded-xl p-4 shadow-sm border",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500",children:"Pending"}),e.jsx("p",{className:"text-2xl font-bold text-yellow-600",children:g.filter(s=>s.status==="Pending").length})]}),e.jsx("div",{className:"p-2 bg-yellow-100 rounded-lg flex items-center justify-center",children:e.jsx(ne,{className:"tm-icon text-yellow-600"})})]})}),e.jsx("div",{className:"bg-white rounded-xl p-4 shadow-sm border",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500",children:"Processed"}),e.jsx("p",{className:"text-2xl font-bold text-green-600",children:g.filter(s=>s.status!=="Pending").length})]}),e.jsx("div",{className:"p-2 bg-green-100 rounded-lg flex items-center justify-center",children:e.jsx(O,{className:"tm-icon text-green-600"})})]})})]}),I==="card"&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"mb-4 flex items-center justify-between",children:e.jsxs("h3",{className:"text-lg font-semibold text-gray-700",children:["Reassignment Requests (",g.filter(s=>s.status==="Pending").length," pending)"]})}),e.jsx("div",{className:"grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-4",children:_?e.jsxs("div",{className:"col-span-full flex flex-col items-center justify-center py-12",children:[e.jsx(y,{className:"tm-icon-hero animate-spin text-blue-500 mb-4"}),e.jsx("p",{className:"text-gray-600",children:"Loading requests..."})]}):g.length===0?e.jsx("div",{className:"col-span-full text-center py-12",children:e.jsxs("div",{className:"max-w-md mx-auto",children:[e.jsx(E,{className:"tm-icon-hero mx-auto text-gray-400 mb-4"}),e.jsx("h3",{className:"text-lg font-semibold text-gray-600 mb-2",children:"No Approval Requests"}),e.jsx("p",{className:"text-gray-500 mb-4",children:"All reassignment requests have been processed."})]})}):g.map(s=>e.jsx("div",{className:"bg-white rounded-xl shadow-sm border hover:shadow-md transition-all duration-200 overflow-hidden",children:e.jsxs("div",{className:"p-5",children:[e.jsx("div",{className:"flex items-start justify-between mb-4",children:e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h3",{className:"text-base font-semibold text-gray-800 truncate mb-1",title:s.title,children:s.title}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"px-2 py-1 bg-orange-100 text-orange-800 text-xs font-medium rounded-full",children:"Task Reassignment"}),e.jsx("span",{className:`px-2 py-1 rounded-full text-xs font-semibold ${s.status==="Approved"?"bg-green-100 text-green-800":s.status==="Rejected"?"bg-red-100 text-red-800":"bg-yellow-100 text-yellow-800"}`,children:s.status})]})]})}),e.jsxs("div",{className:"grid grid-cols-2 gap-3 mb-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500 mb-1",children:"Department"}),e.jsx("p",{className:"text-sm font-medium text-gray-800 truncate",title:s.department,children:s.department})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500 mb-1",children:"Project"}),e.jsx("p",{className:"text-sm font-medium text-gray-800 truncate",title:s.project,children:s.project})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500 mb-1",children:"Requester"}),e.jsx("p",{className:"text-sm font-medium text-gray-800 truncate",title:s.requester,children:s.requester})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500 mb-1",children:"Date"}),e.jsx("p",{className:"text-sm font-medium text-gray-800",children:s.date})]})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("p",{className:"text-xs text-gray-500 mb-1",children:"Current Assignee(s)"}),e.jsx("p",{className:"text-sm text-gray-800 line-clamp-2",title:s.assignedTo,children:s.assignedTo})]}),s.reason&&e.jsx("div",{className:"mb-4",children:e.jsxs("div",{className:"flex items-start gap-2 p-3 bg-blue-50 rounded-lg border border-blue-100",children:[e.jsx(E,{className:"tm-icon text-blue-600 mt-0.5 flex-shrink-0"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-xs font-medium text-blue-800 mb-1",children:"Reason for Reassignment:"}),e.jsx("p",{className:"text-sm text-blue-700 line-clamp-3",title:s.reason,children:s.reason})]})]})}),e.jsx("div",{className:"pt-4 border-t border-gray-100",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("button",{onClick:()=>{},className:"flex-1 p-2 text-sm bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 flex items-center justify-center gap-1 transition-colors",children:[e.jsx(W,{className:"tm-icon"})," Details"]}),s.status==="Pending"&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:()=>B(s.id),disabled:P===s.id,className:"flex-1 p-2 text-sm bg-green-500 text-white rounded-lg hover:bg-green-600 disabled:opacity-50 flex items-center justify-center gap-1 transition-colors",children:[P===s.id?e.jsx(y,{className:"tm-icon animate-spin"}):e.jsx(O,{className:"tm-icon"}),"Approve"]}),e.jsxs("button",{onClick:()=>G(s.id),disabled:v===s.id,className:"flex-1 p-2 text-sm bg-red-500 text-white rounded-lg hover:bg-red-600 disabled:opacity-50 flex items-center justify-center gap-1 transition-colors",children:[v===s.id?e.jsx(y,{className:"tm-icon animate-spin"}):e.jsx(M,{className:"tm-icon"}),"Reject"]})]})]})})]})},s.id))})]}),I==="list"&&e.jsx("div",{className:"bg-white rounded-xl border shadow-sm overflow-hidden",children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{scope:"col",className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Type"}),e.jsx("th",{scope:"col",className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Task"}),e.jsx("th",{scope:"col",className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Requester"}),e.jsx("th",{scope:"col",className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Current Assignee"}),e.jsx("th",{scope:"col",className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Date"}),e.jsx("th",{scope:"col",className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Status"}),e.jsx("th",{scope:"col",className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Actions"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:_?e.jsx("tr",{children:e.jsx("td",{colSpan:"7",className:"px-4 py-8 text-center",children:e.jsxs("div",{className:"flex flex-col items-center justify-center",children:[e.jsx(y,{className:"tm-icon-xl animate-spin text-blue-500 mb-2"}),e.jsx("p",{className:"text-gray-600",children:"Loading requests..."})]})})}):g.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:"7",className:"px-4 py-8 text-center",children:e.jsxs("div",{className:"flex flex-col items-center justify-center",children:[e.jsx(E,{className:"tm-icon-xl text-gray-400 mb-2"}),e.jsx("p",{className:"text-gray-600 font-medium",children:"No Approval Requests"}),e.jsx("p",{className:"text-gray-500 text-sm",children:"All requests have been processed."})]})})}):g.map(s=>e.jsxs("tr",{className:"hover:bg-gray-50 transition-colors",children:[e.jsx("td",{className:"px-4 py-3 whitespace-nowrap",children:e.jsx("span",{className:"px-2 py-1 bg-orange-100 text-orange-800 text-xs font-medium rounded-full",children:"Task Reassignment"})}),e.jsx("td",{className:"px-4 py-3",children:e.jsxs("div",{className:"min-w-0 max-w-xs",children:[e.jsx("p",{className:"text-sm font-medium text-gray-900 truncate",title:s.title,children:s.title}),e.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[e.jsx("span",{className:"text-xs text-gray-500 truncate",title:s.project,children:s.project}),e.jsx("span",{className:"text-gray-300",children:"â€¢"}),e.jsx("span",{className:"text-xs text-gray-500 truncate",title:s.department,children:s.department})]}),s.reason&&e.jsx("p",{className:"text-xs text-blue-600 truncate mt-1",title:s.reason,children:s.reason})]})}),e.jsx("td",{className:"px-4 py-3",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"flex-shrink-0 h-8 w-8 bg-gray-200 rounded-full flex items-center justify-center mr-2",children:e.jsx(z,{className:"tm-icon text-gray-500"})}),e.jsx("span",{className:"text-sm text-gray-900 truncate",title:s.requester,children:s.requester})]})}),e.jsx("td",{className:"px-4 py-3",children:e.jsx("span",{className:"text-sm text-gray-700 line-clamp-2 max-w-xs",title:s.assignedTo,children:s.assignedTo})}),e.jsxs("td",{className:"px-4 py-3 whitespace-nowrap",children:[e.jsx("div",{className:"text-sm text-gray-900",children:s.date}),e.jsx("div",{className:"text-xs text-gray-500",children:s.time})]}),e.jsx("td",{className:"px-4 py-3 whitespace-nowrap",children:e.jsx("span",{className:`px-2 py-1 rounded-full text-xs font-semibold ${s.status==="Approved"?"bg-green-100 text-green-800":s.status==="Rejected"?"bg-red-100 text-red-800":"bg-yellow-100 text-yellow-800"}`,children:s.status})}),e.jsx("td",{className:"px-4 py-3 whitespace-nowrap",children:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{onClick:()=>{},className:"p-1.5 text-gray-500 hover:text-blue-600 hover:bg-blue-50 rounded transition-colors",title:"View Details",children:e.jsx(W,{className:"tm-icon"})}),s.status==="Pending"&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>B(s.id),disabled:P===s.id,className:"p-1.5 text-green-600 hover:text-green-700 hover:bg-green-50 rounded disabled:opacity-50 transition-colors",title:"Approve",children:P===s.id?e.jsx(y,{className:"tm-icon animate-spin"}):e.jsx(O,{className:"tm-icon"})}),e.jsx("button",{onClick:()=>G(s.id),disabled:v===s.id,className:"p-1.5 text-red-600 hover:text-red-700 hover:bg-red-50 rounded disabled:opacity-50 transition-colors",title:"Reject",children:v===s.id?e.jsx(y,{className:"tm-icon animate-spin"}):e.jsx(M,{className:"tm-icon"})})]})]})})]},s.id))})]})})}),K&&r&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm p-4",children:e.jsxs("div",{className:"bg-white rounded-2xl w-full max-w-md p-6 relative shadow-2xl animate-in fade-in duration-200",children:[e.jsx("button",{onClick:()=>{A(!1),S(""),R(null),D(null)},className:"absolute top-4 right-4 text-gray-500 hover:text-gray-700 p-1 rounded-lg hover:bg-gray-100 transition-colors",children:e.jsx(M,{className:"tm-icon"})}),e.jsxs("div",{className:"text-center mb-6",children:[e.jsx("div",{className:"mx-auto w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mb-4",children:e.jsx(z,{className:"tm-icon-xl text-blue-600"})}),e.jsx("h3",{className:"text-xl font-bold text-gray-900 mb-2",children:"Reassign Task"}),e.jsx("p",{className:"text-sm text-gray-500",children:"Select a new employee to assign this task to"})]}),e.jsxs("div",{className:"bg-gray-50 border border-gray-200 rounded-xl p-4 mb-6",children:[e.jsx("h4",{className:"font-semibold text-gray-900 mb-2",children:"Task Details"}),e.jsxs("p",{className:"text-sm text-gray-700 mb-1",children:['"',r.task_title||"Unknown Task",'"']}),e.jsxs("p",{className:"text-xs text-gray-500",children:["From: ",r.requester_name||"Unknown"]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-semibold text-gray-700 mb-2",children:["Assign to Employee ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{value:o,onChange:s=>S(s.target.value),className:"w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all bg-white",disabled:$,children:[e.jsx("option",{value:"",children:"Select an employee..."}),k.map(s=>e.jsx("option",{value:s.id||s._id,children:s.name||s.full_name||`${s.first_name} ${s.last_name}`},s.id||s._id))]})]}),e.jsx("div",{className:"pt-4 border-t border-gray-200",children:e.jsx("button",{onClick:q,disabled:$||!o,className:"w-full py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200 flex items-center justify-center gap-2",children:$?e.jsxs(e.Fragment,{children:[e.jsx(y,{className:"tm-icon animate-spin"}),"Processing..."]}):"Confirm Reassignment"})})]})]})})]})};export{re as default};
