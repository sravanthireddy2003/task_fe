import{b as H,s as K,r,j as e,G as Q,a4 as u,i as g}from"./index-BNLOVeat.js";import{V as Y}from"./ViewToggle-CKq8-IaW.js";const{Eye:L,Check:U,X:E,RefreshCw:p,AlertCircle:S,User:V,Clock:Z}=Q,se=()=>{H(K);const[T,J]=r.useState("list"),[y,I]=r.useState(!0),[b,M]=r.useState([]),[l,N]=r.useState(null),[B,v]=r.useState(!1),[c,w]=r.useState(""),[_,h]=r.useState([]),[C,k]=r.useState(!1),[R,$]=r.useState(null),[j,D]=r.useState(null),[A,P]=r.useState(null),f=async()=>{try{I(!0);const s=await u("/api/tasks/reassign-requests");if(s&&s.success&&Array.isArray(s.requests)){const t=s.requests.reduce((a,n)=>{const i=n.id;return a[i]||(a[i]={...n,assignees:[]}),n.current_assignee_name?(a[i].assignees.push({id:n.current_assignee_id||null,name:n.current_assignee_name,department:n.current_assignee_department_name||null}),a):n.assigned_to?(typeof n.assigned_to=="string"||typeof n.assigned_to=="number"?a[i].assignees.push({id:n.assigned_to,name:null}):typeof n.assigned_to=="object"&&n.assigned_to!==null&&a[i].assignees.push({id:n.assigned_to.id||null,name:n.assigned_to.name||null}),a):(Array.isArray(n.assignees)&&n.assignees.length&&n.assignees.forEach(d=>a[i].assignees.push({id:d.id||null,name:d.name||null,department:d.department})),a)},{});h(Object.values(t))}else h([])}catch{g.error("Failed to load reassignment requests"),h([])}finally{I(!1)}},G=async()=>{try{const s=await u("/api/manager/employees/all");s&&s.success&&Array.isArray(s.data)&&M(s.data)}catch{}},W=(s,t)=>{s&&(N({...t,id:s}),P(s),v(!0))},z=async(s,t)=>{if(!(!s||j)){D(s);try{const a=t.task_id||t.task_public_id,n=await u(`/api/tasks/${a}/reassign-requests/${s}/reject`,{method:"POST"});if(n&&n.error)throw new Error(n.error);g.success((n==null?void 0:n.message)||"Request rejected. Task unlocked."),h(i=>i.map(d=>d.id===s?{...d,status:"REJECTED"}:d)),f()}catch(a){g.error((a==null?void 0:a.message)||"Failed to reject request")}finally{D(null)}}},X=async()=>{if(!l||!c){g.error("Select an employee to reassign the task to");return}if(A){k(!0),$(A);try{const s=l.task_id||l.task_public_id,t=await u(`/api/tasks/${encodeURIComponent(s)}/reassign-requests/${A}/approve`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({new_assignee_id:c,assigned_to:[c],status:"In Progress",task_status:{current_status:"In Progress"}})});if(t&&t.error)throw new Error(t.error||"Approve + reassign failed");try{const a=t&&t.assigned_to&&(t.assigned_to.name||t.assigned_to.full_name)||(b.find(n=>String(n.id)===String(c))||{}).name||String(c);h(n=>n.map(i=>i.id===A?{...i,status:"Approved",assignees:[{id:c,name:a}],responded_at:t.responded_at||i.responded_at,responded_by:t.responded_by||i.responded_by,responder_name:t.responder_name||i.responder_name}:i))}catch(a){console.warn("Failed to update local requests after approve",a)}g.success((t==null?void 0:t.message)||"Reassignment approved and applied"),v(!1),w(""),N(null),P(null),f()}catch(s){g.error((s==null?void 0:s.message)||"Failed to approve and reassign")}finally{k(!1),$(null)}return}k(!0);try{const s=l.task_id||l.task_public_id,t=l.project_public_id;let a=null;try{const m=await u(`/api/tasks/${encodeURIComponent(s)}`),x=(m==null?void 0:m.data)||m||{};Array.isArray(x.assignedUsers)&&x.assignedUsers.length?a=x.assignedUsers[0].id||x.assignedUsers[0].internalId||x.assignedUsers[0].public_id||null:Array.isArray(x.assigned_to)&&x.assigned_to.length?a=x.assigned_to[0]:l&&Array.isArray(l.assignees)&&l.assignees.length&&(a=l.assignees[0].id||null)}catch(m){console.warn("Could not fetch task details for assignee resolution",m)}const n=[];a&&n.push({id:a,readOnly:!0}),c&&n.push({id:c,readOnly:!1});const i={assignedUsers:n,assigned_to:n.map(m=>m.id).filter(Boolean),projectId:t,project_id:t,status:"In Progress",stage:"In Progress",handleResignationRequestId:l.id,task_status:{current_status:"In Progress"}},d=await u(`/api/projects/tasks/${encodeURIComponent(s)}`,{method:"PUT",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify(i)});if(d&&d.error)throw new Error(d.error||"Reassignment failed");g.success("Task reassigned successfully!"),v(!1),w(""),N(null),f()}catch(s){g.error((s==null?void 0:s.message)||"Reassignment failed")}finally{k(!1)}},o=r.useMemo(()=>{const s=t=>{if(!t)return null;if(t.name)return t.department?`${t.name} (${t.department})`:t.name;if(t.id){const a=b.find(n=>String(n.id||n._id)===String(t.id));return a?a.name||a.full_name||a.first_name+" "+a.last_name:String(t.id)}return null};return _.map(t=>({id:t.id,type:"task_reassignment",department:t.project_department_names||`Project ${t.project_id||"Unknown"}`,project:t.project_name||`Project ${t.project_id||"Unknown"}`,title:`Task Reassignment: ${t.task_title||"Unknown Task"}`,requester:t.requester_name||"Unknown",assignedTo:(()=>{if(t.assignees&&t.assignees.length>0){const a=t.assignees.map(n=>s(n)).filter(Boolean);return a.length?a.join(", "):"Unassigned"}return"Unassigned"})(),date:t.requested_at?new Date(t.requested_at).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"}):"N/A",time:t.requested_at?new Date(t.requested_at).toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"}):"",status:t.status==="PENDING"?"Pending":t.status==="APPROVE"?"Approved":t.status==="REJECT"?"Rejected":t.status,requestData:t,reason:t.reason,task:{id:t.task_id,public_id:t.task_public_id,title:t.task_title,status:t.task_status,taskDate:t.taskDate,priority:t.priority,project_id:t.project_id}}))},[_,b]),F=s=>{const t=_.find(a=>a.id===s);t&&W(s,t)},O=s=>{const t=_.find(a=>a.id===s);t&&z(s,t)};return r.useEffect(()=>{f(),G()},[]),e.jsxs("div",{className:"p-4 md:p-6 bg-gray-50 min-h-screen",children:[e.jsxs("div",{className:"flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4",children:[e.jsxs("div",{className:"w-full",children:[e.jsx("h2",{className:"text-2xl md:text-3xl font-bold text-gray-800 mb-2",children:"Approval Workflows"}),e.jsx("p",{className:"text-gray-600 text-sm md:text-base",children:"Manage task reassignment requests and other approvals"})]}),e.jsxs("div",{className:"flex gap-2 w-full md:w-auto",children:[e.jsxs("button",{onClick:f,disabled:y,className:"flex-1 md:flex-none p-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 disabled:opacity-50 flex items-center justify-center gap-2 transition-colors",title:"Refresh",children:[e.jsx(p,{className:y?"tm-icon animate-spin":"tm-icon"}),e.jsx("span",{className:"hidden sm:inline",children:"Refresh"})]}),e.jsx(Y,{mode:T==="list"?"list":"grid",onChange:s=>J(s==="list"?"list":"card")})]})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6",children:[e.jsx("div",{className:"bg-white rounded-xl p-4 shadow-sm border",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500",children:"Total Requests"}),e.jsx("p",{className:"text-2xl font-bold text-gray-800",children:o.length})]}),e.jsx("div",{className:"p-2 bg-blue-100 rounded-lg flex items-center justify-center",children:e.jsx(S,{className:"tm-icon text-blue-600"})})]})}),e.jsx("div",{className:"bg-white rounded-xl p-4 shadow-sm border",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500",children:"Pending"}),e.jsx("p",{className:"text-2xl font-bold text-yellow-600",children:o.filter(s=>s.status==="Pending").length})]}),e.jsx("div",{className:"p-2 bg-yellow-100 rounded-lg flex items-center justify-center",children:e.jsx(Z,{className:"tm-icon text-yellow-600"})})]})}),e.jsx("div",{className:"bg-white rounded-xl p-4 shadow-sm border",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500",children:"Processed"}),e.jsx("p",{className:"text-2xl font-bold text-green-600",children:o.filter(s=>s.status!=="Pending").length})]}),e.jsx("div",{className:"p-2 bg-green-100 rounded-lg flex items-center justify-center",children:e.jsx(U,{className:"tm-icon text-green-600"})})]})})]}),T==="card"&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"mb-4 flex items-center justify-between",children:e.jsxs("h3",{className:"text-lg font-semibold text-gray-700",children:["Reassignment Requests (",o.filter(s=>s.status==="Pending").length," pending)"]})}),e.jsx("div",{className:"grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-4",children:y?e.jsxs("div",{className:"col-span-full flex flex-col items-center justify-center py-12",children:[e.jsx(p,{className:"tm-icon-hero animate-spin text-blue-500 mb-4"}),e.jsx("p",{className:"text-gray-600",children:"Loading requests..."})]}):o.length===0?e.jsx("div",{className:"col-span-full text-center py-12",children:e.jsxs("div",{className:"max-w-md mx-auto",children:[e.jsx(S,{className:"tm-icon-hero mx-auto text-gray-400 mb-4"}),e.jsx("h3",{className:"text-lg font-semibold text-gray-600 mb-2",children:"No Approval Requests"}),e.jsx("p",{className:"text-gray-500 mb-4",children:"All reassignment requests have been processed."})]})}):o.map(s=>e.jsx("div",{className:"bg-white rounded-xl shadow-sm border hover:shadow-md transition-all duration-200 overflow-hidden",children:e.jsxs("div",{className:"p-5",children:[e.jsx("div",{className:"flex items-start justify-between mb-4",children:e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h3",{className:"text-base font-semibold text-gray-800 truncate mb-1",title:s.title,children:s.title}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"px-2 py-1 bg-orange-100 text-orange-800 text-xs font-medium rounded-full",children:"Task Reassignment"}),e.jsx("span",{className:`px-2 py-1 rounded-full text-xs font-semibold ${s.status==="Approved"?"bg-green-100 text-green-800":s.status==="Rejected"?"bg-red-100 text-red-800":"bg-yellow-100 text-yellow-800"}`,children:s.status})]})]})}),e.jsxs("div",{className:"grid grid-cols-2 gap-3 mb-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500 mb-1",children:"Department"}),e.jsx("p",{className:"text-sm font-medium text-gray-800 truncate",title:s.department,children:s.department})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500 mb-1",children:"Project"}),e.jsx("p",{className:"text-sm font-medium text-gray-800 truncate",title:s.project,children:s.project})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500 mb-1",children:"Requester"}),e.jsx("p",{className:"text-sm font-medium text-gray-800 truncate",title:s.requester,children:s.requester})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500 mb-1",children:"Date"}),e.jsx("p",{className:"text-sm font-medium text-gray-800",children:s.date})]})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("p",{className:"text-xs text-gray-500 mb-1",children:"Current Assignee(s)"}),e.jsx("p",{className:"text-sm text-gray-800 line-clamp-2",title:s.assignedTo,children:s.assignedTo})]}),s.reason&&e.jsx("div",{className:"mb-4",children:e.jsxs("div",{className:"flex items-start gap-2 p-3 bg-blue-50 rounded-lg border border-blue-100",children:[e.jsx(S,{className:"tm-icon text-blue-600 mt-0.5 flex-shrink-0"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-xs font-medium text-blue-800 mb-1",children:"Reason for Reassignment:"}),e.jsx("p",{className:"text-sm text-blue-700 line-clamp-3",title:s.reason,children:s.reason})]})]})}),e.jsx("div",{className:"pt-4 border-t border-gray-100",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("button",{onClick:()=>{},className:"flex-1 p-2 text-sm bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 flex items-center justify-center gap-1 transition-colors",children:[e.jsx(L,{className:"tm-icon"})," Details"]}),s.status==="Pending"&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:()=>F(s.id),disabled:R===s.id,className:"flex-1 p-2 text-sm bg-green-500 text-white rounded-lg hover:bg-green-600 disabled:opacity-50 flex items-center justify-center gap-1 transition-colors",children:[R===s.id?e.jsx(p,{className:"tm-icon animate-spin"}):e.jsx(U,{className:"tm-icon"}),"Approve"]}),e.jsxs("button",{onClick:()=>O(s.id),disabled:j===s.id,className:"flex-1 p-2 text-sm bg-red-500 text-white rounded-lg hover:bg-red-600 disabled:opacity-50 flex items-center justify-center gap-1 transition-colors",children:[j===s.id?e.jsx(p,{className:"tm-icon animate-spin"}):e.jsx(E,{className:"tm-icon"}),"Reject"]})]})]})})]})},s.id))})]}),T==="list"&&e.jsx("div",{className:"bg-white rounded-xl border shadow-sm overflow-hidden",children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{scope:"col",className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Type"}),e.jsx("th",{scope:"col",className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Task"}),e.jsx("th",{scope:"col",className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Requester"}),e.jsx("th",{scope:"col",className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Current Assignee"}),e.jsx("th",{scope:"col",className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Date"}),e.jsx("th",{scope:"col",className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Status"}),e.jsx("th",{scope:"col",className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Actions"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:y?e.jsx("tr",{children:e.jsx("td",{colSpan:"7",className:"px-4 py-8 text-center",children:e.jsxs("div",{className:"flex flex-col items-center justify-center",children:[e.jsx(p,{className:"tm-icon-xl animate-spin text-blue-500 mb-2"}),e.jsx("p",{className:"text-gray-600",children:"Loading requests..."})]})})}):o.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:"7",className:"px-4 py-8 text-center",children:e.jsxs("div",{className:"flex flex-col items-center justify-center",children:[e.jsx(S,{className:"tm-icon-xl text-gray-400 mb-2"}),e.jsx("p",{className:"text-gray-600 font-medium",children:"No Approval Requests"}),e.jsx("p",{className:"text-gray-500 text-sm",children:"All requests have been processed."})]})})}):o.map(s=>e.jsxs("tr",{className:"hover:bg-gray-50 transition-colors",children:[e.jsx("td",{className:"px-4 py-3 whitespace-nowrap",children:e.jsx("span",{className:"px-2 py-1 bg-orange-100 text-orange-800 text-xs font-medium rounded-full",children:"Task Reassignment"})}),e.jsx("td",{className:"px-4 py-3",children:e.jsxs("div",{className:"min-w-0 max-w-xs",children:[e.jsx("p",{className:"text-sm font-medium text-gray-900 truncate",title:s.title,children:s.title}),e.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[e.jsx("span",{className:"text-xs text-gray-500 truncate",title:s.project,children:s.project}),e.jsx("span",{className:"text-gray-300",children:"â€¢"}),e.jsx("span",{className:"text-xs text-gray-500 truncate",title:s.department,children:s.department})]}),s.reason&&e.jsx("p",{className:"text-xs text-blue-600 truncate mt-1",title:s.reason,children:s.reason})]})}),e.jsx("td",{className:"px-4 py-3",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"flex-shrink-0 h-8 w-8 bg-gray-200 rounded-full flex items-center justify-center mr-2",children:e.jsx(V,{className:"tm-icon text-gray-500"})}),e.jsx("span",{className:"text-sm text-gray-900 truncate",title:s.requester,children:s.requester})]})}),e.jsx("td",{className:"px-4 py-3",children:e.jsx("span",{className:"text-sm text-gray-700 line-clamp-2 max-w-xs",title:s.assignedTo,children:s.assignedTo})}),e.jsxs("td",{className:"px-4 py-3 whitespace-nowrap",children:[e.jsx("div",{className:"text-sm text-gray-900",children:s.date}),e.jsx("div",{className:"text-xs text-gray-500",children:s.time})]}),e.jsx("td",{className:"px-4 py-3 whitespace-nowrap",children:e.jsx("span",{className:`px-2 py-1 rounded-full text-xs font-semibold ${s.status==="Approved"?"bg-green-100 text-green-800":s.status==="Rejected"?"bg-red-100 text-red-800":"bg-yellow-100 text-yellow-800"}`,children:s.status})}),e.jsx("td",{className:"px-4 py-3 whitespace-nowrap",children:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{onClick:()=>{},className:"p-1.5 text-gray-500 hover:text-blue-600 hover:bg-blue-50 rounded transition-colors",title:"View Details",children:e.jsx(L,{className:"tm-icon"})}),s.status==="Pending"&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>F(s.id),disabled:R===s.id,className:"p-1.5 text-green-600 hover:text-green-700 hover:bg-green-50 rounded disabled:opacity-50 transition-colors",title:"Approve",children:R===s.id?e.jsx(p,{className:"tm-icon animate-spin"}):e.jsx(U,{className:"tm-icon"})}),e.jsx("button",{onClick:()=>O(s.id),disabled:j===s.id,className:"p-1.5 text-red-600 hover:text-red-700 hover:bg-red-50 rounded disabled:opacity-50 transition-colors",title:"Reject",children:j===s.id?e.jsx(p,{className:"tm-icon animate-spin"}):e.jsx(E,{className:"tm-icon"})})]})]})})]},s.id))})]})})}),B&&l&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm p-4",children:e.jsxs("div",{className:"bg-white rounded-2xl w-full max-w-md p-6 relative shadow-2xl animate-in fade-in duration-200",children:[e.jsx("button",{onClick:()=>{v(!1),w(""),N(null),P(null)},className:"absolute top-4 right-4 text-gray-500 hover:text-gray-700 p-1 rounded-lg hover:bg-gray-100 transition-colors",children:e.jsx(E,{className:"tm-icon"})}),e.jsxs("div",{className:"text-center mb-6",children:[e.jsx("div",{className:"mx-auto w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mb-4",children:e.jsx(V,{className:"tm-icon-xl text-blue-600"})}),e.jsx("h3",{className:"text-xl font-bold text-gray-900 mb-2",children:"Reassign Task"}),e.jsx("p",{className:"text-sm text-gray-500",children:"Select a new employee to assign this task to"})]}),e.jsxs("div",{className:"bg-gray-50 border border-gray-200 rounded-xl p-4 mb-6",children:[e.jsx("h4",{className:"font-semibold text-gray-900 mb-2",children:"Task Details"}),e.jsxs("p",{className:"text-sm text-gray-700 mb-1",children:['"',l.task_title||"Unknown Task",'"']}),e.jsxs("p",{className:"text-xs text-gray-500",children:["From: ",l.requester_name||"Unknown"]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-semibold text-gray-700 mb-2",children:["Assign to Employee ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{value:c,onChange:s=>w(s.target.value),className:"w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all bg-white",disabled:C,children:[e.jsx("option",{value:"",children:"Select an employee..."}),b.map(s=>e.jsx("option",{value:s.id||s._id,children:s.name||s.full_name||`${s.first_name} ${s.last_name}`},s.id||s._id))]})]}),e.jsx("div",{className:"pt-4 border-t border-gray-200",children:e.jsx("button",{onClick:X,disabled:C||!c,className:"w-full py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200 flex items-center justify-center gap-2",children:C?e.jsxs(e.Fragment,{children:[e.jsx(p,{className:"tm-icon animate-spin"}),"Processing..."]}):"Confirm Reassignment"})})]})]})})]})};export{se as default};
