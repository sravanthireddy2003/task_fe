import{b as z,s as X,r as l,j as e,G as B,a3 as g,i as c}from"./index-7TXHU69M.js";import{V as H}from"./ViewToggle-CXZN4qWu.js";const{Eye:I,Check:T,X:C,RefreshCw:d,AlertCircle:w,User:q,Clock:K}=B,Z=()=>{z(X);const[k,O]=l.useState("list"),[h,P]=l.useState(!0),[F,G]=l.useState([]),[i,u]=l.useState(null),[L,j]=l.useState(!1),[o,b]=l.useState(""),[f,y]=l.useState([]),[R,N]=l.useState(!1),[v,E]=l.useState(null),[x,U]=l.useState(null),[_,S]=l.useState(null),m=async()=>{try{P(!0);const s=await g("/api/tasks/reassign-requests");if(s&&s.success&&Array.isArray(s.requests)){const t=s.requests.reduce((a,n)=>{const p=n.id;return a[p]||(a[p]={...n,assignees:[]}),n.current_assignee_name&&a[p].assignees.push({name:n.current_assignee_name,department:n.current_assignee_department_name||"Unknown Department"}),a},{});y(Object.values(t))}else y([])}catch{c.error("Failed to load reassignment requests"),y([])}finally{P(!1)}},V=async()=>{try{const s=await g("/api/manager/employees/all");s&&s.success&&Array.isArray(s.data)&&G(s.data)}catch{}},J=(s,t)=>{s&&(u({...t,id:s}),S(s),j(!0))},M=async(s,t)=>{if(!(!s||x)){U(s);try{const a=t.task_id||t.task_public_id,n=await g(`/api/tasks/${a}/reassign-requests/${s}/reject`,{method:"POST"});if(n&&n.error)throw new Error(n.error);c.success((n==null?void 0:n.message)||"Request rejected. Task unlocked."),y(p=>p.map(A=>A.id===s?{...A,status:"REJECTED"}:A)),m()}catch(a){c.error((a==null?void 0:a.message)||"Failed to reject request")}finally{U(null)}}},W=async()=>{if(!i||!o){c.error("Select an employee to reassign the task to");return}if(_){N(!0),E(_);try{const s=i.task_id||i.task_public_id,t=await g(`/api/tasks/${encodeURIComponent(s)}/reassign-requests/${_}/approve`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({new_assignee_id:o})});if(t&&t.error)throw new Error(t.error||"Approve + reassign failed");c.success((t==null?void 0:t.message)||"Reassignment approved and applied"),j(!1),b(""),u(null),S(null),m()}catch(s){c.error((s==null?void 0:s.message)||"Failed to approve and reassign")}finally{N(!1),E(null)}return}N(!0);try{const s=i.task_id||i.task_public_id,t=i.project_public_id,a={assigned_to:o,projectId:t,status:"IN_PROGRESS",handleResignationRequestId:i.id,stage:"IN_PROGRESS",task_status:{current_status:"IN_PROGRESS"},project_id:t},n=await g(`/api/projects/tasks/${encodeURIComponent(s)}`,{method:"PUT",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify(a)});if(n&&n.error)throw new Error(n.error||"Reassignment failed");c.success("Task reassigned successfully!"),j(!1),b(""),u(null),m()}catch(s){c.error((s==null?void 0:s.message)||"Reassignment failed")}finally{N(!1)}},r=l.useMemo(()=>f.map(s=>({id:s.id,type:"task_reassignment",department:s.project_department_names||`Project ${s.project_id||"Unknown"}`,project:s.project_name||`Project ${s.project_id||"Unknown"}`,title:`Task Reassignment: ${s.task_title||"Unknown Task"}`,requester:s.requester_name||"Unknown",assignedTo:s.assignees&&s.assignees.length>0?s.assignees.map(t=>`${t.name} (${t.department})`).join(", "):"Unassigned",date:s.requested_at?new Date(s.requested_at).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"}):"N/A",time:s.requested_at?new Date(s.requested_at).toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"}):"",status:s.status==="PENDING"?"Pending":s.status==="APPROVE"?"Approved":s.status==="REJECT"?"Rejected":s.status,requestData:s,reason:s.reason,task:{id:s.task_id,public_id:s.task_public_id,title:s.task_title,status:s.task_status,taskDate:s.taskDate,priority:s.priority,project_id:s.project_id}})),[f]),D=s=>{const t=f.find(a=>a.id===s);t&&J(s,t)},$=s=>{const t=f.find(a=>a.id===s);t&&M(s,t)};return l.useEffect(()=>{m(),V()},[]),e.jsxs("div",{className:"p-4 md:p-6 bg-gray-50 min-h-screen",children:[e.jsxs("div",{className:"flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4",children:[e.jsxs("div",{className:"w-full",children:[e.jsx("h2",{className:"text-2xl md:text-3xl font-bold text-gray-800 mb-2",children:"Approval Workflows"}),e.jsx("p",{className:"text-gray-600 text-sm md:text-base",children:"Manage task reassignment requests and other approvals"})]}),e.jsxs("div",{className:"flex gap-2 w-full md:w-auto",children:[e.jsxs("button",{onClick:m,disabled:h,className:"flex-1 md:flex-none p-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 disabled:opacity-50 flex items-center justify-center gap-2 transition-colors",title:"Refresh",children:[e.jsx(d,{className:h?"tm-icon animate-spin":"tm-icon"}),e.jsx("span",{className:"hidden sm:inline",children:"Refresh"})]}),e.jsx(H,{mode:k==="list"?"list":"grid",onChange:s=>O(s==="list"?"list":"card")})]})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6",children:[e.jsx("div",{className:"bg-white rounded-xl p-4 shadow-sm border",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500",children:"Total Requests"}),e.jsx("p",{className:"text-2xl font-bold text-gray-800",children:r.length})]}),e.jsx("div",{className:"p-2 bg-blue-100 rounded-lg flex items-center justify-center",children:e.jsx(w,{className:"tm-icon text-blue-600"})})]})}),e.jsx("div",{className:"bg-white rounded-xl p-4 shadow-sm border",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500",children:"Pending"}),e.jsx("p",{className:"text-2xl font-bold text-yellow-600",children:r.filter(s=>s.status==="Pending").length})]}),e.jsx("div",{className:"p-2 bg-yellow-100 rounded-lg flex items-center justify-center",children:e.jsx(K,{className:"tm-icon text-yellow-600"})})]})}),e.jsx("div",{className:"bg-white rounded-xl p-4 shadow-sm border",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500",children:"Processed"}),e.jsx("p",{className:"text-2xl font-bold text-green-600",children:r.filter(s=>s.status!=="Pending").length})]}),e.jsx("div",{className:"p-2 bg-green-100 rounded-lg flex items-center justify-center",children:e.jsx(T,{className:"tm-icon text-green-600"})})]})})]}),k==="card"&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"mb-4 flex items-center justify-between",children:e.jsxs("h3",{className:"text-lg font-semibold text-gray-700",children:["Reassignment Requests (",r.filter(s=>s.status==="Pending").length," pending)"]})}),e.jsx("div",{className:"grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-4",children:h?e.jsxs("div",{className:"col-span-full flex flex-col items-center justify-center py-12",children:[e.jsx(d,{className:"tm-icon-hero animate-spin text-blue-500 mb-4"}),e.jsx("p",{className:"text-gray-600",children:"Loading requests..."})]}):r.length===0?e.jsx("div",{className:"col-span-full text-center py-12",children:e.jsxs("div",{className:"max-w-md mx-auto",children:[e.jsx(w,{className:"tm-icon-hero mx-auto text-gray-400 mb-4"}),e.jsx("h3",{className:"text-lg font-semibold text-gray-600 mb-2",children:"No Approval Requests"}),e.jsx("p",{className:"text-gray-500 mb-4",children:"All reassignment requests have been processed."})]})}):r.map(s=>e.jsx("div",{className:"bg-white rounded-xl shadow-sm border hover:shadow-md transition-all duration-200 overflow-hidden",children:e.jsxs("div",{className:"p-5",children:[e.jsx("div",{className:"flex items-start justify-between mb-4",children:e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h3",{className:"text-base font-semibold text-gray-800 truncate mb-1",title:s.title,children:s.title}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"px-2 py-1 bg-orange-100 text-orange-800 text-xs font-medium rounded-full",children:"Task Reassignment"}),e.jsx("span",{className:`px-2 py-1 rounded-full text-xs font-semibold ${s.status==="Approved"?"bg-green-100 text-green-800":s.status==="Rejected"?"bg-red-100 text-red-800":"bg-yellow-100 text-yellow-800"}`,children:s.status})]})]})}),e.jsxs("div",{className:"grid grid-cols-2 gap-3 mb-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500 mb-1",children:"Department"}),e.jsx("p",{className:"text-sm font-medium text-gray-800 truncate",title:s.department,children:s.department})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500 mb-1",children:"Project"}),e.jsx("p",{className:"text-sm font-medium text-gray-800 truncate",title:s.project,children:s.project})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500 mb-1",children:"Requester"}),e.jsx("p",{className:"text-sm font-medium text-gray-800 truncate",title:s.requester,children:s.requester})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500 mb-1",children:"Date"}),e.jsx("p",{className:"text-sm font-medium text-gray-800",children:s.date})]})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("p",{className:"text-xs text-gray-500 mb-1",children:"Current Assignee(s)"}),e.jsx("p",{className:"text-sm text-gray-800 line-clamp-2",title:s.assignedTo,children:s.assignedTo})]}),s.reason&&e.jsx("div",{className:"mb-4",children:e.jsxs("div",{className:"flex items-start gap-2 p-3 bg-blue-50 rounded-lg border border-blue-100",children:[e.jsx(w,{className:"tm-icon text-blue-600 mt-0.5 flex-shrink-0"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-xs font-medium text-blue-800 mb-1",children:"Reason for Reassignment:"}),e.jsx("p",{className:"text-sm text-blue-700 line-clamp-3",title:s.reason,children:s.reason})]})]})}),e.jsx("div",{className:"pt-4 border-t border-gray-100",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("button",{onClick:()=>{},className:"flex-1 p-2 text-sm bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 flex items-center justify-center gap-1 transition-colors",children:[e.jsx(I,{className:"tm-icon"})," Details"]}),s.status==="Pending"&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:()=>D(s.id),disabled:v===s.id,className:"flex-1 p-2 text-sm bg-green-500 text-white rounded-lg hover:bg-green-600 disabled:opacity-50 flex items-center justify-center gap-1 transition-colors",children:[v===s.id?e.jsx(d,{className:"tm-icon animate-spin"}):e.jsx(T,{className:"tm-icon"}),"Approve"]}),e.jsxs("button",{onClick:()=>$(s.id),disabled:x===s.id,className:"flex-1 p-2 text-sm bg-red-500 text-white rounded-lg hover:bg-red-600 disabled:opacity-50 flex items-center justify-center gap-1 transition-colors",children:[x===s.id?e.jsx(d,{className:"tm-icon animate-spin"}):e.jsx(C,{className:"tm-icon"}),"Reject"]})]})]})})]})},s.id))})]}),k==="list"&&e.jsx("div",{className:"bg-white rounded-xl border shadow-sm overflow-hidden",children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{scope:"col",className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Type"}),e.jsx("th",{scope:"col",className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Task"}),e.jsx("th",{scope:"col",className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Requester"}),e.jsx("th",{scope:"col",className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Current Assignee"}),e.jsx("th",{scope:"col",className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Date"}),e.jsx("th",{scope:"col",className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Status"}),e.jsx("th",{scope:"col",className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Actions"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:h?e.jsx("tr",{children:e.jsx("td",{colSpan:"7",className:"px-4 py-8 text-center",children:e.jsxs("div",{className:"flex flex-col items-center justify-center",children:[e.jsx(d,{className:"tm-icon-xl animate-spin text-blue-500 mb-2"}),e.jsx("p",{className:"text-gray-600",children:"Loading requests..."})]})})}):r.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:"7",className:"px-4 py-8 text-center",children:e.jsxs("div",{className:"flex flex-col items-center justify-center",children:[e.jsx(w,{className:"tm-icon-xl text-gray-400 mb-2"}),e.jsx("p",{className:"text-gray-600 font-medium",children:"No Approval Requests"}),e.jsx("p",{className:"text-gray-500 text-sm",children:"All requests have been processed."})]})})}):r.map(s=>e.jsxs("tr",{className:"hover:bg-gray-50 transition-colors",children:[e.jsx("td",{className:"px-4 py-3 whitespace-nowrap",children:e.jsx("span",{className:"px-2 py-1 bg-orange-100 text-orange-800 text-xs font-medium rounded-full",children:"Task Reassignment"})}),e.jsx("td",{className:"px-4 py-3",children:e.jsxs("div",{className:"min-w-0 max-w-xs",children:[e.jsx("p",{className:"text-sm font-medium text-gray-900 truncate",title:s.title,children:s.title}),e.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[e.jsx("span",{className:"text-xs text-gray-500 truncate",title:s.project,children:s.project}),e.jsx("span",{className:"text-gray-300",children:"â€¢"}),e.jsx("span",{className:"text-xs text-gray-500 truncate",title:s.department,children:s.department})]}),s.reason&&e.jsx("p",{className:"text-xs text-blue-600 truncate mt-1",title:s.reason,children:s.reason})]})}),e.jsx("td",{className:"px-4 py-3",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"flex-shrink-0 h-8 w-8 bg-gray-200 rounded-full flex items-center justify-center mr-2",children:e.jsx(q,{className:"tm-icon text-gray-500"})}),e.jsx("span",{className:"text-sm text-gray-900 truncate",title:s.requester,children:s.requester})]})}),e.jsx("td",{className:"px-4 py-3",children:e.jsx("span",{className:"text-sm text-gray-700 line-clamp-2 max-w-xs",title:s.assignedTo,children:s.assignedTo})}),e.jsxs("td",{className:"px-4 py-3 whitespace-nowrap",children:[e.jsx("div",{className:"text-sm text-gray-900",children:s.date}),e.jsx("div",{className:"text-xs text-gray-500",children:s.time})]}),e.jsx("td",{className:"px-4 py-3 whitespace-nowrap",children:e.jsx("span",{className:`px-2 py-1 rounded-full text-xs font-semibold ${s.status==="Approved"?"bg-green-100 text-green-800":s.status==="Rejected"?"bg-red-100 text-red-800":"bg-yellow-100 text-yellow-800"}`,children:s.status})}),e.jsx("td",{className:"px-4 py-3 whitespace-nowrap",children:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{onClick:()=>{},className:"p-1.5 text-gray-500 hover:text-blue-600 hover:bg-blue-50 rounded transition-colors",title:"View Details",children:e.jsx(I,{className:"tm-icon"})}),s.status==="Pending"&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>D(s.id),disabled:v===s.id,className:"p-1.5 text-green-600 hover:text-green-700 hover:bg-green-50 rounded disabled:opacity-50 transition-colors",title:"Approve",children:v===s.id?e.jsx(d,{className:"tm-icon animate-spin"}):e.jsx(T,{className:"tm-icon"})}),e.jsx("button",{onClick:()=>$(s.id),disabled:x===s.id,className:"p-1.5 text-red-600 hover:text-red-700 hover:bg-red-50 rounded disabled:opacity-50 transition-colors",title:"Reject",children:x===s.id?e.jsx(d,{className:"tm-icon animate-spin"}):e.jsx(C,{className:"tm-icon"})})]})]})})]},s.id))})]})})}),L&&i&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm p-4",children:e.jsxs("div",{className:"bg-white rounded-2xl w-full max-w-md p-6 relative shadow-2xl animate-in fade-in duration-200",children:[e.jsx("button",{onClick:()=>{j(!1),b(""),u(null),S(null)},className:"absolute top-4 right-4 text-gray-500 hover:text-gray-700 p-1 rounded-lg hover:bg-gray-100 transition-colors",children:e.jsx(C,{className:"tm-icon"})}),e.jsxs("div",{className:"text-center mb-6",children:[e.jsx("div",{className:"mx-auto w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mb-4",children:e.jsx(q,{className:"tm-icon-xl text-blue-600"})}),e.jsx("h3",{className:"text-xl font-bold text-gray-900 mb-2",children:"Reassign Task"}),e.jsx("p",{className:"text-sm text-gray-500",children:"Select a new employee to assign this task to"})]}),e.jsxs("div",{className:"bg-gray-50 border border-gray-200 rounded-xl p-4 mb-6",children:[e.jsx("h4",{className:"font-semibold text-gray-900 mb-2",children:"Task Details"}),e.jsxs("p",{className:"text-sm text-gray-700 mb-1",children:['"',i.task_title||"Unknown Task",'"']}),e.jsxs("p",{className:"text-xs text-gray-500",children:["From: ",i.requester_name||"Unknown"]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-semibold text-gray-700 mb-2",children:["Assign to Employee ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{value:o,onChange:s=>b(s.target.value),className:"w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all bg-white",disabled:R,children:[e.jsx("option",{value:"",children:"Select an employee..."}),F.map(s=>e.jsx("option",{value:s.id||s._id,children:s.name||s.full_name||`${s.first_name} ${s.last_name}`},s.id||s._id))]})]}),e.jsx("div",{className:"pt-4 border-t border-gray-200",children:e.jsx("button",{onClick:W,disabled:R||!o,className:"w-full py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200 flex items-center justify-center gap-2",children:R?e.jsxs(e.Fragment,{children:[e.jsx(d,{className:"tm-icon animate-spin"}),"Processing..."]}):"Confirm Reassignment"})})]})]})})]})};export{Z as default};
