import React from "react";
import ReactDOM from "react-dom/client";
import { Provider } from "react-redux";
import { BrowserRouter } from "react-router-dom";
import App from "./App.jsx";
import "./index.css";
import { toast } from "sonner";

import store from "./redux/store";
import { setTokens, getAccessToken, getRefreshToken, clearTokens } from "./utils/tokenService";
import { setAuthToken } from "./App/httpHandler";
import { logout, getProfile, refreshToken } from "./redux/slices/authSlice";

// Ensure tenantId default from environment is persisted for API calls
try {
  const defaultTenant = import.meta.env.VITE_TENANT_ID || null;
  if (defaultTenant && !localStorage.getItem("tenantId")) {
    localStorage.setItem("tenantId", defaultTenant);
  }
} catch (e) {
  // Ignore errors
}

// Bootstrapping sequence: initialize tokens/axios, try silent refresh, then render
async function boot() {
  try {
    // Load dev seed if exists (optional)
    try {
      const mod = await import("./dev/dev_token");
      const seed = mod?.DEV_SEED;
      if (seed?.token) {
        setTokens(seed.token, seed.refreshToken || null, "local");
        localStorage.setItem("userInfo", JSON.stringify(seed.user));
        localStorage.setItem("user", JSON.stringify(seed.user));
        localStorage.setItem("tm_access_token", seed.token);
        localStorage.setItem("accessToken", seed.token);
      }
    } catch (e) {
      // no dev seed â€” ignore
    }

    // Listen for logout events from interceptor
    if (typeof window !== 'undefined') {
      window.addEventListener('auth:logout', () => {
        store.dispatch(logout());
      });
    }

    // Initialize axios default Authorization header
    try {
      const access = getAccessToken();
      const refresh = getRefreshToken();
      if (refresh) {
        setAuthToken(access || null, refresh, "local");

        // Send refresh token on every page refresh
        try {
          await store.dispatch(refreshToken()).unwrap();
          // After successful refresh, load profile
          await store.dispatch(getProfile()).unwrap();
        } catch (refreshErr) {
          console.warn("Token refresh on startup failed", refreshErr);
          // Clear invalid tokens and logout user
          clearTokens();
          localStorage.removeItem("userInfo");
          store.dispatch(logout());
          setTimeout(() => {
            toast.error("Your session has expired. Please login again.");
          }, 100);
        }
      }
    } catch (e) {
      // ignore errors in token initialization
      console.warn("Token initialization error:", e);
    }
  } catch (error) {
    console.error("Boot error:", error);
  } finally {
    ReactDOM.createRoot(document.getElementById("root")).render(
      <Provider store={store}>
        <BrowserRouter>
          <App />
        </BrowserRouter>
      </Provider>
    );
  }
}

boot();